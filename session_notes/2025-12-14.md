# Session: 2025-12-14

## Worked On
- Fixed false positives in Soufflé generic verifier
- Implemented heuristic fact extraction for input facts (FREE, no LLM)
- Added word stemming for fuzzy matching
- Reduced duplicate error violations

## Problem: False Positives

Initial Soufflé results showed many false positives:
- webarena.6 had 12 violations, but many were invalid
- LLM fact extraction only found 10 visible elements (should be 78)
- "quantities sold" didn't match "Quantity" (exact matching too strict)
- 14 duplicate `ignored_error` violations for same error

## Solutions Implemented

### 1. Heuristic Fact Extraction (`heuristic_fact_extractor.py`)

**Replaces LLM for input fact extraction** - completely FREE.

Parses AXTree directly using regex patterns:
```python
ELEMENT_PATTERNS = [
    r"\[(\d+)\]\s+link\s+'([^']+)'",      # Links
    r"\[(\d+)\]\s+button\s+'([^']+)'",    # Buttons
    r"StaticText\s+'([^']+)'",            # Static text
    r"\[(\d+)\]\s+tab\s+'([^']+)'",       # Tabs
    r"\[(\d+)\]\s+cell\s+'([^']+)'",      # Cells
    # ... more patterns
]
```

**Result:** 78 visible elements extracted (vs 10 from LLM)

### 2. Error Message Deduplication

Added key phrase matching to avoid duplicate error violations:
```python
def is_duplicate(msg: str) -> bool:
    # Extract key phrases for comparison
    key_phrases = []
    if "invalid data" in msg_lower:
        key_phrases.append("invalid data")
    if "timeout" in msg_lower:
        key_phrases.append("timeout")
    # Create normalized key
    norm_key = " ".join(sorted(key_phrases))
    if norm_key in seen_normalized:
        return True
    seen_normalized.add(norm_key)
    return False
```

**Result:** 14 duplicate errors → 1 error

### 3. Word Stemming for Fuzzy Matching

Added simple stemming to handle plurals:
```python
def _stem_word(self, word: str) -> str:
    if word.endswith('ies') and len(word) > 3:
        return word[:-3] + 'y'  # quantities -> quantity
    if word.endswith('s') and len(word) > 2:
        return word[:-1]  # products -> product
    if word.endswith('ing') and len(word) > 4:
        return word[:-3]  # selling -> sell
    return word
```

**Result:** "quantities sold" now matches "Quantity" via common stem

## Final Results

| Case | Before All Fixes | After All Fixes | Improvement |
|------|-----------------|-----------------|-------------|
| webarena.168 | 4 violations | 3 violations | 1 false positive removed |
| webarena.489 | 17 violations | 4 violations | 13 false positives removed |
| webarena.6 | 18 violations | 4 violations | 14 false positives removed |

**All remaining violations verified as REAL:**
- `ungrounded_reference`: Agent references data not in AXTree (e.g., "table format", "top 5 entries")
- `ignored_error`: Agent ignores error messages (e.g., "This tab contains invalid data")
- `target_not_visible`: Action targets elements not visible

## Architecture Update

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Heuristic     │     │      LLM        │     │    Soufflé      │
│   Extraction    │     │   Extraction    │     │    (Datalog)    │
│   (Input)       │     │   (Output)      │     │                 │
│   FREE          │     │   $$$           │     │   FREE          │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         └───────────┬───────────┘                       │
                     │                                   │
                     ▼                                   │
              ┌─────────────────┐                        │
              │  Fact Files     │────────────────────────┘
              │  (.facts)       │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐     ┌─────────────────┐
              │ Consistency     │     │  Common Sense   │
              │ (Soufflé)       │     │  (LLM)          │
              │ FREE            │     │  $$$            │
              └────────┬────────┘     └────────┬────────┘
                       │                       │
                       └───────────┬───────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │  Final Result   │
                          └─────────────────┘
```

## Files Modified/Created

### New Files
- `script/verifier/heuristic_fact_extractor.py` - Rule-based input fact extraction

### Modified Files
- `script/verifier/souffle_generic_verifier.py`:
  - Integrated heuristic extraction for input facts
  - Added `_stem_word()` and `_get_word_stems()` for fuzzy matching
  - Updated `_reference_matches_visible()` to use stemming

## Key Insight

**Separation of concerns:**
- Input facts: Use heuristics (fast, FREE, complete)
- Output facts: Use LLM (semantic understanding needed)
- Consistency: Use Datalog (deterministic, transparent)
- Common sense: Use LLM (requires world knowledge)

This hybrid approach minimizes LLM usage while maintaining accuracy.
